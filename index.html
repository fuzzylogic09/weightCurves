<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Croissance Enfante</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
  .graph-container { width: 100%; max-width: 900px; margin: auto; }
  #lastPoint { text-align: center; font-weight: bold; margin: 10px; }
</style>
</head>
<body>

<div class="graph-container">
  <h2>Z-score</h2>
  <div id="zscorePlot"></div>
  
  <h2>Percentiles</h2>
  <div id="percentilePlot"></div>

  <div id="lastPoint">Chargement...</div>
</div>

<script>
// ===== CONFIG =====
const dob = "15-01-2023"; // Date de naissance JJ-MM-AAAA
const whoCsvUrl = "LMS_fille.csv"; // CSV OMS avec Month,L,M,S
const dataUrl = "poids.txt"; // Fichier utilisateur (JJ-MM-AAAA,poids)

// ===== FONCTIONS =====
function parseDateFR(dateStr) {
    const [d, m, y] = dateStr.split('-').map(Number);
    return new Date(y, m - 1, d);
}

function ageInMonths(dob, date) {
    return (date.getFullYear() - dob.getFullYear()) * 12 +
           (date.getMonth() - dob.getMonth()) +
           (date.getDate() - dob.getDate()) / 30.4375;
}

function weightFromZ(L, M, S, z) {
    if (L === 0) return M * Math.exp(S * z);
    return M * Math.pow(1 + L * S * z, 1 / L);
}

function zFromWeight(L, M, S, weight) {
    if (L === 0) return Math.log(weight / M) / S;
    return (Math.pow(weight / M, L) - 1) / (L * S);
}

function percentileFromZ(z) {
    // Approximation CDF gaussienne
    const p = 0.5 * (1 + erf(z / Math.sqrt(2)));
    return p * 100;
}

function erf(x) {
    // Approximation fonction d'erreur
    const sign = x >= 0 ? 1 : -1;
    x = Math.abs(x);
    const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    const t = 1 / (1 + p * x);
    const y = 1 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
    return sign * y;
}

// ===== CHARGEMENT DES DONNÉES =====
Promise.all([
    fetch(whoCsvUrl).then(r => r.text()),
    fetch(dataUrl).then(r => r.text())
]).then(([whoCsv, userTxt]) => {
    const dobDate = parseDateFR(dob);

    // OMS LMS
    const lms = whoCsv.trim().split("\n").slice(1).map(line => {
        const [month, L, M, S] = line.split(",").map(Number);
        return { month, L, M, S };
    });

    // Données utilisateur
    const userData = userTxt.trim().split("\n").map(line => {
        const [dateStr, wStr] = line.split(",");
        const date = parseDateFR(dateStr.trim());
        return { 
            date, 
            age: ageInMonths(dobDate, date), 
            weight: parseFloat(wStr)
        };
    });

    // Graphique Percentiles
    const zLevels = [-1.881, -1.036, 0, 1.036, 1.881]; // ≈ P3, P15, P50, P85, P97
    const percLabels = ["P3", "P15", "P50", "P85", "P97"];
    const percentileTraces = zLevels.map((z, i) => ({
        x: lms.map(d => d.month),
        y: lms.map(d => weightFromZ(d.L, d.M, d.S, z)),
        mode: "lines",
        name: percLabels[i],
        line: { dash: (i === 2 ? "solid" : "dot") }
    }));

    percentileTraces.push({
        x: userData.map(d => d.age),
        y: userData.map(d => d.weight),
        mode: "markers+lines",
        name: "Données enfant",
        marker: { size: 8, color: "red" }
    });

    Plotly.newPlot("percentilePlot", percentileTraces, {
        xaxis: { title: "Âge (mois)" },
        yaxis: { title: "Poids (kg)" },
        responsive: true
    });

    // Graphique Z-score
    const zUser = userData.map(d => {
        const ref = lms.find(r => Math.abs(r.month - d.age) < 0.5);
        if (!ref) return null;
        return zFromWeight(ref.L, ref.M, ref.S, d.weight);
    });

    const zscoreTrace = {
        x: userData.map(d => d.age),
        y: zUser,
        mode: "markers+lines",
        name: "Z-score",
        marker: { size: 8, color: "blue" }
    };

    const zRefLines = Array.from({length: 7}, (_,i) => i-3).map(z => ({
        x: [0, 48], y: [z, z],
        mode: "lines",
        name: `z=${z}`,
        line: { dash: "dot", color: "gray" },
        hoverinfo: "skip"
    }));

    Plotly.newPlot("zscorePlot", [zscoreTrace, ...zRefLines], {
        xaxis: { title: "Âge (mois)" },
        yaxis: { title: "Z-score" },
        responsive: true
    });

    // Dernier point
    const last = userData[userData.length - 1];
    const lastRef = lms.find(r => Math.abs(r.month - last.age) < 0.5);
    const lastZ = zFromWeight(lastRef.L, lastRef.M, lastRef.S, last.weight);
    const lastP = percentileFromZ(lastZ);
    document.getElementById("lastPoint").textContent =
        `Dernier point : z-score = ${lastZ.toFixed(2)}, percentile ≈ ${lastP.toFixed(1)}%`;

});
</script>

</body>
</html>
