<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Courbes OMS fille</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 10px; }
  #zscorePlot, #percentilePlot { width: 100%; max-width: 900px; height: 500px; margin: auto; }
  #lastPoint { text-align: center; margin-top: 15px; font-weight: bold; }
  #reloadBtn {
    display: block;
    margin: 30px auto;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
  }
</style>
</head>
<body>

<h2>Graphique Z-score</h2>
<div id="zscorePlot"></div>

<h2>Graphique Percentiles</h2>
<div id="percentilePlot"></div>

<div id="lastPoint">Chargement...</div>

<button id="reloadBtn">Recharger les données</button>

<script>
const baseURL = "https://fuzzylogic09.github.io/weightCurves/";

function parseDateFR(str) {
  const [d,m,y] = str.split("-").map(Number);
  return new Date(y,m-1,d);
}

function ageMonths(dob, date) {
  return (date.getFullYear() - dob.getFullYear()) * 12 + (date.getMonth() - dob.getMonth()) + (date.getDate() - dob.getDate())/30.4375;
}

function weightFromZ(L,M,S,z) {
  if(L===0) return M * Math.exp(S*z);
  return M * Math.pow(1 + L*S*z, 1/L);
}

function zFromWeight(L,M,S,w) {
  if(L===0) return Math.log(w/M)/S;
  return (Math.pow(w/M, L) - 1)/(L*S);
}

function erf(x) {
  let sign = (x >= 0) ? 1 : -1;
  x = Math.abs(x);
  const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429,p=0.3275911;
  let t=1/(1+p*x);
  let y=1-((((((a5*t+a4)*t)+a3)*t+a2)*t+a1)*t)*Math.exp(-x*x);
  return sign*y;
}

function percentileFromZ(z) {
  return 0.5*(1+erf(z/Math.sqrt(2)))*100;
}

function findNearestLMS(lms, age) {
  let nearest = lms[0];
  let diffMin = Math.abs(lms[0].Month - age);
  for(let i=1; i<lms.length; i++) {
    const diff = Math.abs(lms[i].Month - age);
    if(diff < diffMin) {
      nearest = lms[i];
      diffMin = diff;
    }
  }
  return nearest;
}

async function loadData() {
  try {
    const now = Date.now();
    const dataUrl = `${baseURL}poids.txt?nocache=${now}`;
    const lmsUrl = `${baseURL}LMS_fille.csv?nocache=${now}`;
    const dobStr = "15-01-2023";

    const [userTxt, lmsTxt] = await Promise.all([
      fetch(dataUrl, {cache:"no-store"}).then(r => {
        if(!r.ok) throw new Error(`Erreur chargement poids.txt: ${r.status}`);
        return r.text();
      }),
      fetch(lmsUrl, {cache:"no-store"}).then(r => {
        if(!r.ok) throw new Error(`Erreur chargement LMS_fille.csv: ${r.status}`);
        return r.text();
      })
    ]);

    const dob = parseDateFR(dobStr);

    const lms = lmsTxt.trim().split("\n").slice(1).map(line => {
      const [Month,L,M,S] = line.split(",").map(Number);
      return {Month,L,M,S};
    });

    const userData = userTxt.trim().split("\n").map(line => {
      const parts = line.split(",");
      if(parts.length < 2) return null;
      const date = parseDateFR(parts[0].trim());
      const weight = parseFloat(parts[1]);
      return {age: ageMonths(dob, date), weight};
    }).filter(x => x !== null);

    // Percentiles
    const zLevels = [-1.881, -1.036, 0, 1.036, 1.881];
    const percLabels = ["P3", "P15", "P50", "P85", "P97"];
    const percentileTraces = zLevels.map((z, i) => ({
      x: lms.map(d => d.Month),
      y: lms.map(d => weightFromZ(d.L, d.M, d.S, z)),
      mode: "lines",
      name: percLabels[i],
      line: { dash: i === 2 ? "solid" : "dot" }
    }));

    percentileTraces.push({
      x: userData.map(d => d.age),
      y: userData.map(d => d.weight),
      mode: "markers+lines",
      name: "Données enfant",
      marker: { size: 8, color: "red" },
      line: { color: "red" }
    });

    Plotly.newPlot("percentilePlot", percentileTraces, {
      xaxis: {title: "Âge (mois)", range: [0, 48]},
      yaxis: {title: "Poids (kg)"},
      responsive: true
    });

    // Z-score
    const zUser = userData.map(d => {
      const ref = findNearestLMS(lms, d.age);
      return zFromWeight(ref.L, ref.M, ref.S, d.weight);
    });

    const zscoreTrace = {
      x: userData.map(d => d.age),
      y: zUser,
      mode: "markers+lines",
      name: "Z-score enfant",
      marker: { size: 8, color: "blue" },
      line: { color: "blue" }
    };

    const zRefLines = Array.from({length:7}, (_,i)=>i-3).map(z => ({
      x: [0,48],
      y: [z,z],
      mode: "lines",
      name: `z=${z}`,
      line: { dash: "dot", color: "gray" },
      hoverinfo: "skip"
    }));

    Plotly.newPlot("zscorePlot", [zscoreTrace, ...zRefLines], {
      xaxis: {title: "Âge (mois)", range: [0, 48]},
      yaxis: {title: "Z-score"},
      responsive: true
    });

    if(userData.length > 0) {
      const last = userData[userData.length-1];
      const lastRef = findNearestLMS(lms, last.age);
      const lastZ = zFromWeight(lastRef.L, lastRef.M, lastRef.S, last.weight);
      const lastP = percentileFromZ(lastZ);
      document.getElementById("lastPoint").textContent =
        `Dernier point : z-score = ${lastZ.toFixed(2)}, percentile ≈ ${lastP.toFixed(1)}%`;
    } else {
      document.getElementById("lastPoint").textContent = "Pas de données utilisateur.";
    }

  } catch(e) {
    console.error("Erreur chargement ou parsing :", e);
    document.getElementById("lastPoint").textContent = "Erreur chargement données.";
  }
}

// Chargement initial
loadData();

// Reload au clic bouton
document.getElementById("reloadBtn").addEventListener("click", () => {
  document.getElementById("lastPoint").textContent = "Rechargement...";
  loadData();
});
</script>

</body>
</html>
