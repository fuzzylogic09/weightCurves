<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title courbes de croissance OMS</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  canvas {
    max-width: 100%;
    height: auto;
  }
  .chart-container {
    width: 95%;
    margin: auto;
  }
</style>
</head>
<body>

<h2>Courbes de croissance (Z-Score)</h2>
<div class="chart-container">
  <canvas id="zscoreChart"></canvas>
</div>

<h2>Courbes de croissance (Percentiles)</h2>
<div class="chart-container">
  <canvas id="percentileChart"></canvas>
</div>

<p id="lastPoint"></p>

<script>
const now = Date.now();
const dataUrl = `https://fuzzylogic09.github.io/weightCurves/poids.txt?nocache=${now}`;
const lmsUrl  = `https://fuzzylogic09.github.io/weightCurves/LMS_fille.csv?nocache=${now}`;
const birthDate = "01-01-2023"; // JJ-MM-AAAA

function parseDate(dateStr) {
    const [day, month, year] = dateStr.split("-").map(Number);
    return new Date(year, month - 1, day);
}

function ageInMonths(d1, d2) {
    return ((d2.getFullYear() - d1.getFullYear()) * 12) + (d2.getMonth() - d1.getMonth()) + (d2.getDate() - d1.getDate())/30.4375;
}

function zscoreFromWeight(ageMonths, weight, lmsData) {
    const entry = lmsData.find(d => Math.abs(d.Month - ageMonths) < 0.01);
    if (!entry) return null;
    const { L, M, S } = entry;
    return (Math.pow(weight / M, L) - 1) / (L * S);
}

function percentileFromZ(z) {
    return 0.5 * (1 + erf(z / Math.sqrt(2))) * 100;
}

function erf(x) {
    const sign = x >= 0 ? 1 : -1;
    x = Math.abs(x);
    const t = 1 / (1 + 0.3275911 * x);
    const y = 1 - (((((1.061405429 * t - 1.453152027) * t) + 1.421413741) * t - 0.284496736) * t + 0.254829592) * t * Math.exp(-x * x);
    return sign * y;
}

async function loadData() {
    const userRes = await fetch(dataUrl, { cache: "no-store" });
    const lmsRes  = await fetch(lmsUrl,  { cache: "no-store" });

    if (!userRes.ok) throw new Error(`Erreur chargement poids.txt: ${userRes.status}`);
    if (!lmsRes.ok) throw new Error(`Erreur chargement LMS_fille.csv: ${lmsRes.status}`);

    const userText = await userRes.text();
    const lmsText  = await lmsRes.text();

    const lmsData = lmsText.trim().split("\n").slice(1).map(line => {
        const [Month, L, M, S] = line.split(",").map(Number);
        return { Month, L, M, S };
    });

    const birth = parseDate(birthDate);
    const userData = userText.trim().split("\n").map(line => {
        const [dateStr, weightStr] = line.split(/\s+/);
        const date = parseDate(dateStr);
        return {
            age: ageInMonths(birth, date),
            weight: parseFloat(weightStr)
        };
    });

    const zData = userData.map(d => ({
        x: d.age,
        y: zscoreFromWeight(d.age, d.weight, lmsData)
    }));

    const pData = zData.map(d => ({
        x: d.x,
        y: percentileFromZ(d.y)
    }));

    drawCharts(lmsData, zData, pData);

    if (userData.length > 0) {
        const lastZ = zData[zData.length - 1].y.toFixed(2);
        const lastP = pData[pData.length - 1].y.toFixed(1);
        document.getElementById("lastPoint").innerText =
            `Dernier point â†’ Z-score : ${lastZ}, Percentile : ${lastP}`;
    }
}

function drawCharts(lmsData, zData, pData) {
    const ctxZ = document.getElementById('zscoreChart').getContext('2d');
    const ctxP = document.getElementById('percentileChart').getContext('2d');

    const sdLines = [-3,-2,-1,0,1,2,3].map(sd => ({
        label: `SD${sd>=0?'+':''}${sd}`,
        data: lmsData.map(d => ({x: d.Month, y: sd})),
        borderColor: `hsl(${(sd+3)*50},70%,50%)`,
        fill: false,
        borderWidth: 1,
        pointRadius: 0
    }));

    new Chart(ctxZ, {
        type: 'line',
        data: { datasets: [...sdLines, { label: 'Enfant', data: zData, borderColor: 'black', backgroundColor: 'black', showLine: false, pointRadius: 5 }] },
        options: { responsive: true, plugins: { zoom: { zoom: { wheel: {enabled: true}, pinch: {enabled: true}, mode: 'xy'} } }, scales: { x: { type: 'linear', min: 0, max: 48 } } }
    });

    const percentiles = [3,15,50,85,97].map(p => ({
        label: `P${p}`,
        data: lmsData.map(d => ({x: d.Month, y: p})),
        borderColor: `hsl(${p},70%,50%)`,
        fill: false,
        borderWidth: 1,
        pointRadius: 0
    }));

    new Chart(ctxP, {
        type: 'line',
        data: { datasets: [...percentiles, { label: 'Enfant', data: pData, borderColor: 'black', backgroundColor: 'black', showLine: false, pointRadius: 5 }] },
        options: { responsive: true, plugins: { zoom: { zoom: { wheel: {enabled: true}, pinch: {enabled: true}, mode: 'xy'} } }, scales: { x: { type: 'linear', min: 0, max: 48 }, y: { min: 0, max: 100 } } }
    });
}

loadData().catch(err => console.error(err));
</script>

</body>
</html>
